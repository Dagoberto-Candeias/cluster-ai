input {
  # Use beats input to receive logs from filebeat or other beats
  beats {
    port => 5044
    type => "beats"
  }

  # Use tcp input as an alternative for receiving logs
  tcp {
    port => 5000
    type => "tcp"
    codec => json
  }

  # Use http input for REST API log ingestion
  http {
    port => 8083
    codec => plain {
      charset => "UTF-8"
    }
  }
}

filter {
  # Handle beats input
  if [type] == "beats" {
    # Process beats input - beats already provides structured data
    if !("_jsonparsefailure" in [tags]) {
      # Only process if JSON parsing was successful
    }
  }

  # Handle TCP input - expect JSON format
  if [type] == "tcp" {
    # TCP input with json codec already parses JSON
    # Add any additional processing here if needed
    if !("_jsonparsefailure" in [tags]) {
      # Only process if JSON parsing was successful
    }
  }

  # Handle HTTP input
  if [type] == "http" {
    # Process HTTP input as plain text
    if [message] {
      # Add timestamp if not present
      if ![@timestamp] {
        mutate {
          add_field => { "[@timestamp]" => "%{@timestamp}" }
        }
      }
    }
  }

  # Common filters for all inputs
  if [message] {
    # Remove empty fields
    mutate {
      gsub => [
        "message", "\n", " ",
        "message", "\r", " "
      ]
    }
  }
}

output {
  # Send to stdout for debugging
  stdout {
    codec => rubydebug
  }

  # Send to Elasticsearch
  if [@metadata][pipeline] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}"
      pipeline => "%{[@metadata][pipeline]}"
    }
  } else {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "logstash-%{+YYYY.MM.dd}"
    }
  }
}
